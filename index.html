<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Guardião do Portal Linear</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      transition: background 1s ease;
      background-color: #e0f7fa;
    }
       #menu {
      opacity: 1;
      transition: opacity 1s ease;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(62, 47, 28, 0.95); /* escuro como taverna */
      color: #f9f1e7;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 2000;
      text-shadow: 1px 1px 2px #000;
    }
    #menu h1 {
      font-family: 'Cinzel', serif;
      font-size: 3em;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px #6b4c11;
    }
    #menu button {
      background: linear-gradient(45deg, #6b4c11, #a98307);
      border: 2px solid #d9c686;
      padding: 15px 40px;
      font-size: 22px;
      color: #f9f1e7;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 0 25px rgba(169, 131, 7, 0.7);
      transition: all 0.3s ease;
      font-weight: 700;
      font-family: 'Cinzel', serif;
    }
    #menu button:hover {
      box-shadow: 0 0 40px rgba(169, 131, 7, 1);
      transform: scale(1.1);
    }
    #transicao-fase {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: black;
      pointer-events: none; /* Allows clicks to pass through if it's not fully covering initially */
      clip-path: circle(0% at center); /* Initial state: hidden as a small point */
      transition: clip-path 1s ease-in-out; /* Animation timing */
      z-index: 4000; /* Ensure it's on top of other modals/game elements during transition */
    }
    #game-area {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: none;
      opacity: 0;
      transition: opacity 1s ease;
    }
    #game-area {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: none;
      opacity: 0;
      transition: opacity 1s ease;
      background-image: url('assets/aldeia.png'); /* Updated path */
      background-size: cover;
      background-position: center center;
    }
    #personagem, #npc { /* Removed #obstaculo from this group */
      position: absolute;
      width: 50px;
      height: 50px;
      border-radius: 12px;
      border: 2px solid #fff; /* Keep border for visibility or adjust as needed */
    }
    .portal-desafio { /* New CSS class for portals */
      position: absolute;
      width: 50px; 
      height: 50px; 
      background-color: rgba(255, 223, 186, 0.7); /* Light, somewhat transparent parchment/gold */
      border: 2px dashed #6b4c11; /* Wooden-like dashed border */
      border-radius: 10px; 
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); /* Gold glow */
      cursor: help; 
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: none; /* Initially hidden */
    }
    .portal-desafio:hover {
      transform: scale(1.1);
      box-shadow: 0 0 25px rgba(255, 215, 0, 1);
    }
    .portal-desafio.active-portal {
      box-shadow: 0 0 25px rgba(255, 255, 100, 1), 0 0 35px rgba(255, 223, 0, 0.7); /* Brighter, more prominent glow */
      animation: pulseGlow 1.5s infinite alternate;
    }

    @keyframes pulseGlow {
      from {
        box-shadow: 0 0 25px rgba(255, 255, 100, 0.9), 0 0 35px rgba(255, 223, 0, 0.6);
      }
      to {
        box-shadow: 0 0 35px rgba(255, 255, 150, 1), 0 0 45px rgba(255, 223, 0, 0.8);
      }
    }

    .tela-tremendo {
      animation: tremor 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }

    @keyframes tremor {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); } /* More jittery */
      20%, 40%, 60%, 80% { transform: translateX(3px); }
    }

    #personagem {
      background-image: url('assets/persoganem_principal.png'); /* Updated path */
      background-size: cover; /* Or 'contain' if aspect ratio is an issue */
      background-position: center;
      top: 260px;
      left: 100px;
      /* border: none; /* Optional: remove border if icon has good transparency */
    }
    #npc {
      background-image: url('assets/npc_idosa.png'); /* Updated path */
      background-size: cover; /* Or 'contain' */
      background-position: center;
      top: 200px;
      left: 200px;
      /* border: none; /* Optional */
    }
    #fala-npc {
      display: none;
      position: absolute;
      top: -90px;
      left: 50%;
      transform: translateX(-50%);
      background: #f9f1e7; /* Parchment */
      padding: 10px 14px;
      border: 2px solid #6b4c11; /* Dark brown/wood */
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #3a2f1c; /* Dark brown text */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      max-width: 240px;
      width: max-content;
      max-height: 150px;
      overflow-wrap: break-word;
      white-space: normal;
      text-align: center;
      z-index: 10;
      animation: destaqueFala 0.3s ease-in-out;
    }
    #npc-hint {
      position: absolute;
      top: 105%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff8e1;
      color: #333;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 12px;
      box-shadow: 0 0 8px #0002;
      z-index: 5;
    }
    #obstaculo {
      background-color: #5d4037;
      top: 300px;
      left: 400px;
    }
    #pontuacao, #fase-indicador, #cronometro {
      position: fixed;
      top: 10px;
      background: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 0 10px #0002;
      z-index: 100;
      user-select: none;
    }
    #pontuacao { left: 10px; }
    #fase-indicador { right: 10px; }
    /* #cronometro { left: 50%; transform: translateX(-50%); } */ /* Removed cronometro style */

    /* .tela-tremendo will be kept from its first declaration */
    /* @keyframes tremor will be kept from its first declaration */

    /* Modal Styling */
    #custom-modal, #custom-prompt-modal {
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: none; /* Initially hidden */
      justify-content: center;
      align-items: center;
    }
    #modal-content, #prompt-modal-content {
      background-color: #f9f1e7; /* Light parchment color */
      color: #3a2f1c; /* Dark brown text */
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      text-align: center;
      border: 3px solid #6b4c11; /* Wooden-like border */
      font-family: 'Cinzel', serif; /* Medieval font */
      max-width: 500px;
    }
    #modal-content p, #prompt-modal-content p { /* Ensure paragraphs within modals also use Cinzel */
      font-family: 'Cinzel', serif;
    }
    #modal-close-button, #prompt-modal-submit-button, #prompt-modal-cancel-button {
      background: linear-gradient(45deg, #6b4c11, #a98307);
      border: 2px solid #d9c686;
      padding: 10px 20px;
      font-size: 18px;
      color: #f9f1e7;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
      font-family: 'Cinzel', serif;
    }
    #prompt-modal-input {
      padding: 10px;
      font-size: 16px;
      border: 2px solid #6b4c11;
      border-radius: 5px;
      margin-bottom: 20px;
      width: 80%;
      font-family: 'Cinzel', serif; /* Ensure Cinzel for input */
    }
    /* #pontuacao, #fase-indicador, #cronometro { // Style for removed elements
      font-family: 'Cinzel', serif; 
    } */
    #player-hud span#vidas-hud .heart-icon { /* More specific selector for HUD hearts if needed */
        /* font-size: 22px; */ /* Example if different size needed from modal */
        /* margin-right: 3px; */
    }
    #npc-hint {
      font-family: 'Cinzel', serif; /* Apply Cinzel to NPC hint */
      background: #fff8e1; /* Existing - light parchment */
      color: #3a2f1c; /* Darker text for better contrast on light parchment */
      border: 1px solid #6b4c11; /* Consistent border */
    }
    .heart-icon {
      color: red;
      font-size: 24px; /* Adjust as needed */
      margin-left: 5px; /* Example spacing if used inline */
    }
    .tela-tremendo {
      animation: tremor 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }

    @keyframes tremor {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); } /* More jittery */
      20%, 40%, 60%, 80% { transform: translateX(3px); }
    }

    .portal-desafio.portal-vermelho {
      border-color: #ff0000; /* Red border */
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.8), 0 0 25px rgba(200, 0, 0, 0.7); /* Intense red glow */
    }

    .portal-desafio.portal-vermelho.active-portal {
      border-color: #ff4d4d; /* Brighter red border for active state */
      box-shadow: 0 0 25px rgba(255, 0, 0, 1), 0 0 35px rgba(255, 50, 50, 0.8), 0 0 45px rgba(255, 100, 100, 0.5); /* More intense and layered red glow */
      animation: pulseGlowRed 1.2s infinite alternate; /* Different or more intense animation */
    }

    @keyframes pulseGlowRed {
      from {
        box-shadow: 0 0 25px rgba(255, 0, 0, 0.8), 0 0 35px rgba(220, 20, 60, 0.6);
      }
      to {
        box-shadow: 0 0 35px rgba(255, 50, 50, 1), 0 0 45px rgba(255, 100, 100, 0.8);
      }
    }
  </style>
</head>
<body>
  <div id="menu">
    <h1>Guardião do Portal Linear</h1>
    <button onclick="iniciarJogo()">Iniciar desafio</button>
  </div>
  <div id="game-area" style="opacity: 0; transition: opacity 1s ease;">
    <div id="player-hud" style="position: fixed; top: 10px; left: 10px; background: rgba(249, 241, 231, 0.9); /* Parchment background */ color: #3a2f1c; /* Dark brown text */ padding: 10px 15px; border-radius: 8px; font-family: 'Cinzel', serif; font-size:18px; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 100; user-select: none;">
      Vidas: <span id="vidas-hud"></span> | Moedas: <span id="moedas-hud">0</span> | Poção: <span id="pocao-hud">0</span>
    </div>
    <div id="personagem"></div>
    <div id="npc">
      <div id="fala-npc">👋</div>
      <div id="npc-hint">Pressione F para falar</div>
    </div>
    <!-- <div id="obstaculo"></div> --> <!-- Removed static obstacle -->
    <!-- <div id="pontuacao">Pontos: <span id="pontos">0</span></div> --> <!-- Removed -->
    <!-- <div id="fase-indicador">Fase: <span id="fase">1</span></div> --> <!-- Removed -->
    <!-- <div id="cronometro">Tempo: <span id="tempo">60</span>s</div> --> <!-- Removed cronometro display -->
    <div id="transicao-fase"></div>
    <audio id="som-transicao" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_1fbb34f7b4.mp3?filename=transition-visual-effect-6111.mp3"></audio>
  </div>

  <!-- Custom Modal for Alerts -->
  <div id="custom-modal">
    <div id="modal-content">
      <p id="modal-message"></p>
      <button id="modal-close-button">Fechar</button>
    </div>
  </div>

  <!-- Custom Modal for Prompts -->
  <div id="custom-prompt-modal">
    <div id="prompt-modal-content">
      <p id="prompt-modal-question"></p>
      <div id="vidas-display" style="margin-top: 10px; margin-bottom: 15px;"></div> 
      <div id="moedas-modal-display-container" style="margin-top: 5px; font-size: 16px;">Moedas: <span id="moedas-modal-display">0</span></div>
      <input type="text" id="prompt-modal-input">
      <button id="prompt-modal-submit-button">Enviar</button>
      <button id="prompt-modal-cancel-button">Cancelar</button>
      <button id="usar-dica-pocao-btn" style="display:none; margin-left: 10px; background: #4CAF50; /* Greenish color for potion */ padding: 10px 20px; font-size: 18px; color: #f9f1e7; border-radius: 8px; cursor: pointer; font-family: 'Cinzel', serif; border: 2px solid #388E3C;">Usar Dica da Poção</button>
    </div>
  </div>

  <div id="reino-portal-area" style="display:none; width:100vw; height:100vh; background-size:cover; background-position:center; display:flex; justify-content:center; align-items:center; text-align:center; color:white; font-family: 'Cinzel', serif;">
    <!-- Content will be injected by JavaScript -->
  </div>

  <script>
    // --- DOM ELEMENT REFERENCES ---
    const menu = document.getElementById('menu');
    const gameArea = document.getElementById('game-area');
    const personagem = document.getElementById('personagem');
    const npc = document.getElementById('npc'); // Added for completeness, though not directly used in existing functions
    const falaNpc = document.getElementById('fala-npc');
    const npcHint = document.getElementById('npc-hint');
    // const obstaculo = document.getElementById('obstaculo'); // Removed
    // const pontosEl = document.getElementById('pontos'); // Removed
    // const faseEl = document.getElementById('fase'); // Removed
    // const tempoEl = document.getElementById('tempo'); // Removed
    const somTransicao = document.getElementById('som-transicao');
    const transicaoFase = document.getElementById('transicao-fase');

    // Modal elements
    const customModal = document.getElementById('custom-modal');
    const modalMessage = document.getElementById('modal-message');
    const modalCloseButton = document.getElementById('modal-close-button');
    const customPromptModal = document.getElementById('custom-prompt-modal');
    const promptModalQuestion = document.getElementById('prompt-modal-question');
    const promptModalInput = document.getElementById('prompt-modal-input');
    const promptModalSubmitButton = document.getElementById('prompt-modal-submit-button');
    const promptModalCancelButton = document.getElementById('prompt-modal-cancel-button');

    // --- GLOBAL VARIABLES ---
    // --- GAME CORE LOGIC & STATE ---
    let locaisAldeia = [];
    let portalAtual = null;
    let proximoLocalIndex = 0; 
    let currentChallengeDetails = null; // To store { challenge, localNome } for current prompt
    // let pontos = 0; // Removed
    let moedasJogador = 0;
    let desafiosConcluidosContador = 0;
    let desafioFerrariaConcluido = false;
    let jogadorTemPocao = false; 
    let dicasRestantesPocao = 0;
    let esperandoAnuncioPortal = false;
    let mapaAtual = 'aldeia';
    let faseAtual = 0;
    // let tempo = 60; // Removed
    // let cronometro; // Removed
    let x = 200, y = 260, passo = 20; // Character position and step
    let vidasJogador;
    const VIDAS_INICIAIS = 3;


    // --- NPC & DIALOGUE LOGIC ---
    let falouComNpc = false;
    let falaNpcIntervaloDigitacao = null; 
    let falaNpcPersistenteVisivel = false;
    let promptCallback = null; // To store the callback for the prompt (related to modal, but driven by NPC/Challenge interaction)

    const fases = [
      { fundo: '#e0f7fa', corObstaculo: '#5d4037', fala: 'Bem-vindo ao desafio 1!' },
      { fundo: '#fff3e0', corObstaculo: '#d84315', fala: 'Prepare-se para a fase 2!' },
      { fundo: '#f3e5f5', corObstaculo: '#6a1b9a', fala: 'Você está indo bem na fase 3!' },
      { fundo: '#ede7f6', corObstaculo: '#4527a0', fala: 'Quase lá na fase 4!' },
      { fundo: '#e8f5e9', corObstaculo: '#2e7d32', fala: 'Última fase! Boa sorte!' }
    ];

    const dicasFaseadas = [ // Moved here as it's primarily NPC dialogue content
      [
        'Continue em frente! Supere os obstáculos e resolva os sistemas para vencer.',
        'Use as teclas direcionais para explorar o mapa.',
        'Evite perder tempo, o cronômetro está correndo!',
        'Desafios com vetores podem surgir, lembre-se de suas propriedades!' // New Hint
      ],
      [
        'Dica da fase 2: observe o número de variáveis em cada equação.',
        'Você pode somar ou subtrair equações para eliminar uma variável.',
        'Equações simples ajudam na dedução: tente reorganizar!',
        'Matrizes? Some ou multiplique com atenção!' // New Hint
      ],
      [
        'Dica da fase 3: tente isolar uma variável para facilitar a substituição.',
        'Às vezes trocar a ordem das equações ajuda.',
        'Não se esqueça de verificar suas contas básicas!',
        'Transformações lineares podem parecer complexas, mas siga a definição.' // New Hint
      ],
      [
        'Dica da fase 4: eliminar uma variável pode simplificar bastante o sistema.',
        'Multiplique uma equação se precisar igualar os coeficientes.',
        'A substituição ainda é útil, tente de novo!',
        'Às vezes, um desafio vetorial é apenas uma questão de aplicar a fórmula correta.'
      ],
      [
        'Dica final: revisar os passos anteriores pode te ajudar a corrigir erros.',
        'A solução correta precisa satisfazer ambas as equações.',
        'Leia com atenção: às vezes o erro está no sinal!',
        'Dominar as matrizes abre muitos portais!'
      ]
    ];

    // --- MODAL LOGIC ---
    function atualizarExibicaoVidas() { // This specifically updates the MODAL's lives display
      const vidasModalDisplayEl = document.getElementById('vidas-display');
      if (vidasModalDisplayEl) {
        vidasModalDisplayEl.innerHTML = ''; // Clear previous hearts
        if (vidasJogador <= 0) {
            vidasModalDisplayEl.textContent = 'Vidas: 0';
        } else {
            for (let i = 0; i < vidasJogador; i++) {
                const heartSpan = document.createElement('span');
                heartSpan.className = 'heart-icon'; // Uses existing .heart-icon style
                heartSpan.textContent = '❤️';
                vidasModalDisplayEl.appendChild(heartSpan);
            }
        }
      }
    }

    function atualizarHud() {
      // Vidas HUD
      const vidasHudEl = document.getElementById('vidas-hud');
      if (vidasHudEl) { 
        vidasHudEl.innerHTML = ''; 
        if (vidasJogador <= 0) {
            vidasHudEl.textContent = '0'; // Show '0' if no lives
        } else {
            for (let i = 0; i < vidasJogador; i++) {
              const heartSpan = document.createElement('span');
              heartSpan.className = 'heart-icon'; 
              heartSpan.textContent = '❤️';
              vidasHudEl.appendChild(heartSpan);
            }
        }
      }

      // Moedas HUD
      const moedasHudEl = document.getElementById('moedas-hud');
      if (moedasHudEl) { 
        moedasHudEl.textContent = moedasJogador;
      }

      // Poção HUD
      const pocaoHudEl = document.getElementById('pocao-hud');
      if (pocaoHudEl) {
        pocaoHudEl.textContent = dicasRestantesPocao;
      }
    }

    function atualizarModalDisplays() {
      atualizarExibicaoVidas(); // Updates lives in modal

      // Moedas no Modal
      const moedasModalEl = document.getElementById('moedas-modal-display');
      if (moedasModalEl) { 
        moedasModalEl.textContent = moedasJogador;
      }
    }
    
    function showCustomAlert(message, callback) { 
      modalMessage.textContent = message;
      customModal.style.display = 'flex';
      customModal.onCloseCallback = callback; 
    }

    function closeCustomAlert() {
      customModal.style.display = 'none';
      if (typeof customModal.onCloseCallback === 'function') {
        customModal.onCloseCallback();
        customModal.onCloseCallback = null; 
      }
    }

    function showCustomPrompt(question, callback) {
      promptCallback = callback;
      promptModalQuestion.textContent = question;
      promptModalInput.value = ''; 
      atualizarModalDisplays(); // Updates lives and coins in modal

      const usarDicaPocaoBtn = document.getElementById('usar-dica-pocao-btn');
      if (dicasRestantesPocao > 0 && portalAtual && portalAtual.id !== 'portal_perigoso') {
        usarDicaPocaoBtn.style.display = 'inline-block'; 
        usarDicaPocaoBtn.onclick = function() { // Assign new or overwrite existing onclick
          if (dicasRestantesPocao > 0) {
            if (currentChallengeDetails && currentChallengeDetails.challenge && currentChallengeDetails.challenge.dica) {
              showCustomAlert("Dica da Poção: " + currentChallengeDetails.challenge.dica);
              dicasRestantesPocao--;
              atualizarHud(); // Update HUD for potion count
              atualizarModalDisplays(); // Also update modal displays if needed (e.g. if potion count was there)
              usarDicaPocaoBtn.style.display = 'none'; // Hide button after use for this challenge instance
            } else {
              showCustomAlert("Não há dica disponível para este desafio ou detalhes do desafio não encontrados.");
            }
          }
        };
      } else {
        usarDicaPocaoBtn.style.display = 'none';
        usarDicaPocaoBtn.onclick = null; // Remove listener
      }

      customPromptModal.style.display = 'flex';
      promptModalInput.focus(); 
    }

    function submitCustomPrompt() {
      const value = promptModalInput.value;
      customPromptModal.style.display = 'none';
      if (promptCallback) {
        promptCallback(value);
      }
    }

    function cancelCustomPrompt() {
      customPromptModal.style.display = 'none';
      if (promptCallback) {
        promptCallback(null); // Indicate cancellation
      }
    }

    // --- GAME CORE LOGIC & STATE --- (Continued)
    function activatePortal(local) {
      if (!local || !local.portalElement) {
        console.error("Tentativa de ativar local inválido ou sem portalElement:", local);
        return;
      }

      if (portalAtual && portalAtual.portalElement) {
        portalAtual.portalElement.style.display = 'none'; 
        portalAtual.portalElement.classList.remove('active-portal');
        // Remove portal-vermelho if the previous portal had it (safer to do it here)
        portalAtual.portalElement.classList.remove('portal-vermelho'); 
      }
      
      local.portalElement.style.display = 'block';
      local.portalElement.classList.add('active-portal');
      
      if (local.id !== 'portal_perigoso') {
        local.desafioAtual = desafios[Math.floor(Math.random() * desafios.length)];
      } else {
        local.desafioAtual = null; // Dangerous portal has no standard challenge from 'desafios' array
                                 // Its challenge logic will be custom in apresentarDesafio or similar
        local.portalElement.classList.add('portal-vermelho'); // Ensure it gets its distinct style
      }
      local.concluido = false; 
      portalAtual = local; 
    }

    function ativarPortalPerigoso() {
      console.log("Ativando o Portal Perigoso!");
      let portalPerigosoObj = locaisAldeia.find(l => l.id === 'portal_perigoso');

      if (!portalPerigosoObj) {
        portalPerigosoObj = {
          id: 'portal_perigoso',
          nome: 'O Portal Instável',
          coords: { x: 1200, y: 170 }, // As per NPC dialogue
          desafioAtual: null, 
          concluido: false,
          portalElement: null
        };
        locaisAldeia.push(portalPerigosoObj); 

        const portalDiv = document.createElement('div');
        portalDiv.id = 'portal-' + portalPerigosoObj.id;
        portalDiv.classList.add('portal-desafio'); 
        // portalDiv.classList.add('portal-vermelho'); // Will be added by activatePortal or directly after
        portalDiv.style.left = portalPerigosoObj.coords.x + 'px';
        portalDiv.style.top = portalPerigosoObj.coords.y + 'px';
        portalDiv.style.display = 'none'; 
        gameArea.appendChild(portalDiv);
        portalPerigosoObj.portalElement = portalDiv;
      } else {
        portalPerigosoObj.concluido = false; 
      }
      
      activatePortal(portalPerigosoObj); 
      // activatePortal will now also add 'portal-vermelho' if id is 'portal_perigoso'
      // or we can do it explicitly again here to be sure, though it might be redundant if activatePortal handles it.
      // if (portalPerigosoObj.portalElement) {
      //   portalPerigosoObj.portalElement.classList.add('portal-vermelho');
      // }
    }

    function iniciarJogo() {
      vidasJogador = VIDAS_INICIAIS;
      moedasJogador = 0;
      desafiosConcluidosContador = 0;
      desafioFerrariaConcluido = false;
      jogadorTemPocao = false;
      dicasRestantesPocao = 0;
      esperandoAnuncioPortal = false;
      mapaAtual = 'aldeia';
      falaNpcPersistenteVisivel = false;
      if (falaNpcIntervaloDigitacao) {
        clearInterval(falaNpcIntervaloDigitacao);
        falaNpcIntervaloDigitacao = null;
      }
      atualizarHud(); // Initial HUD update
      
      locaisAldeia = [
        { 
          id: 'taverna', 
          nome: 'a Taverna do Javali Caolho', 
          coords: { x: 360, y: 680 }, 
          desafioAtual: null, 
          concluido: false, 
          portalElement: null 
        },
        { 
          id: 'capela', 
          nome: 'a Capela da Vila', 
          coords: { x: 500, y: 150 }, 
          desafioAtual: null, 
          concluido: false, 
          portalElement: null 
        },
        { 
          id: 'mercado_sul', 
          nome: 'o Mercado Sul', 
          coords: { x: 1400, y: 780 }, 
          desafioAtual: null, 
          concluido: false, 
          portalElement: null 
        },
        { 
          id: 'ferraria', 
          nome: 'a Ferraria do Pégaso Negro', 
          coords: { x: 1720, y: 170 }, 
          desafioAtual: null, 
          concluido: false, 
          portalElement: null 
        }
      ];

      const gameAreaDiv = document.getElementById('game-area');
      locaisAldeia.forEach(local => {
        const portalDiv = document.createElement('div');
        portalDiv.id = 'portal-' + local.id;
        portalDiv.classList.add('portal-desafio');
        portalDiv.style.left = local.coords.x + 'px';
        portalDiv.style.top = local.coords.y + 'px';
        gameAreaDiv.appendChild(portalDiv);
        local.portalElement = portalDiv; 
      });
      
      menu.style.transition = 'opacity 1s ease';
      menu.style.opacity = '0';
      setTimeout(() => {
        menu.style.display = 'none';
        gameArea.style.display = 'block';
        setTimeout(() => { gameArea.style.opacity = '1'; }, 50); // Ensure opacity transition
        aplicarFase(faseAtual); // faseAtual is 0 initially
        // Obstacle is already placed by default CSS, first challenge will be random
        mostrarFalaDigitada("Olá, herói! Fale comigo (pressione 'F') para receber sua primeira missão e proteger nossos portais!");
        // Timer will start when first challenge prompt is closed or solved.
      }, 1000);
    }

    function aplicarFase(fase) { // This function might need re-evaluation with fixed portals
      const config = fases[fase % fases.length]; // Current phase color logic, might be kept for body background
      transicaoFase.style.clipPath = 'circle(150% at center)';
      setTimeout(() => {
        document.body.style.backgroundColor = config.fundo;
        // obstaculo.style.backgroundColor = config.corObstaculo; // #obstaculo is removed
        // faseEl.textContent = (fase % fases.length) + 1; // faseEl is removed, remove this line
        transicaoFase.style.clipPath = 'circle(0% at center)';
        // tempo = 60; // Removed
        // atualizarTempo(); // Removed
      }, 500); // Duration of transition animation
    }

    // function retryCurrentChallenge() { // Removed
    //     if (portalAtual && portalAtual.desafioAtual) {
    //         apresentarDesafio(portalAtual.desafioAtual, portalAtual.nome);
    //     } else {
    //         console.warn("RetryCurrentChallenge chamado sem portalAtual ou desafioAtual válido.");
    //     }
    // }

    // function iniciarContador() { // Removed
    //   clearInterval(cronometro); 
    //   cronometro = setInterval(() => {
    //     tempo--;
    //     atualizarTempo();
    //     if (tempo <= 0) {
    //       clearInterval(cronometro);
    //       vidasJogador--;
    //       atualizarExibicaoVidas();
    //       if (vidasJogador <= 0) {
    //         showCustomAlert("Fim de Jogo! O tempo esgotou na sua última vida. O portal repele você...", () => { 
    //           location.reload(); 
    //         });
    //       } else {
    //         if (portalAtual && portalAtual.desafioAtual) {
    //             showCustomAlert(`Tempo Esgotado! Você perdeu uma vida. Tente este desafio novamente.\n${portalAtual.desafioAtual.dica}`, () => {
    //                 retryCurrentChallenge();
    //             });
    //         } else {
    //             showCustomAlert("Tempo Esgotado! Você perdeu uma vida.", () => {
    //             });
    //         }
    //       }
    //     }
    //   }, 1000);
    // }

    // function atualizarTempo() { // Removed
    //   tempoEl.textContent = tempo;
    // }

    // --- NPC & DIALOGUE LOGIC --- (Continued)
    function mostrarFalaDigitada(texto, persistente = false) {
      if (falaNpcIntervaloDigitacao) {
        clearInterval(falaNpcIntervaloDigitacao); 
        falaNpcIntervaloDigitacao = null;
      }
      falaNpc.textContent = ""; 
      falaNpc.style.display = "block";
      falaNpcPersistenteVisivel = persistente; 

      let i = 0;
      falaNpcIntervaloDigitacao = setInterval(() => { // Assign to global interval
        if (i < texto.length) {
          falaNpc.textContent += texto[i];
          i++;
        } else {
          clearInterval(falaNpcIntervaloDigitacao); // Clear the global interval
          falaNpcIntervaloDigitacao = null; 

          if (!persistente) {
            setTimeout(() => {
              // Only hide if it's still not persistent AND no new message has started typing
              if (!falaNpcPersistenteVisivel && !falaNpcIntervaloDigitacao) { 
                 falaNpc.style.display = "none";
              }
            }, 2500); 
          }
          // If 'persistente' is true, it remains displayed.
          // falaNpcPersistenteVisivel is already true if 'persistente' was true.
        }
      }, 40); 
    }

    // --- CHARACTER MOVEMENT & COLLISION ---
    function detectarColisao(el1, el2) { // Made generic for potential other collision detections
      const r1 = el1.getBoundingClientRect();
      const r2 = el2.getBoundingClientRect();
      return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
    }

    // --- CHALLENGE HANDLING LOGIC ---
    const desafios = [
      {
        type: 'linear_system',
        pergunta: `2x + 3y = 12\n4x - y = 5`, // Keep for now
        text: `Resolva o sistema:\n2x + 3y = 12\n4x - y = 5`, // New generic field
        resposta: '3,2',
        dica: 'Dica: multiplique a segunda equação por 3 para eliminar y com a primeira.',
        explicacao: 'Multiplicando a segunda equação por 3: 12x - 3y = 15. Somando com a primeira: 2x + 3y = 12 resulta em 14x = 27, então x = 3, y = 2.'
      },
      {
        type: 'linear_system',
        pergunta: `x + y = 10\nx - y = 4`,
        text: `Resolva o sistema:\nx + y = 10\nx - y = 4`,
        resposta: '7,3',
        dica: 'Dica: some as duas equações para encontrar x diretamente.',
        explicacao: 'Somando as equações: 2x = 14, x = 7. Substituindo: 7 + y = 10, y = 3.'
      },
      {
        type: 'linear_system',
        pergunta: `3x + 2y = 12\n2x - y = 1`,
        text: `Resolva o sistema:\n3x + 2y = 12\n2x - y = 1`,
        resposta: '2,3',
        dica: 'Dica: isole y na segunda equação e substitua na primeira.',
        explicacao: 'Da segunda: y = 2x - 1. Substituindo na primeira: 3x + 2(2x - 1) = 12 → 3x + 4x - 2 = 12 → 7x = 14 → x = 2, y = 3.'
      },
      {
        type: 'linear_system',
        pergunta: `x + 2y = 8\n3x - y = 5`,
        text: `Resolva o sistema:\nx + 2y = 8\n3x - y = 5`,
        resposta: '3,2.5',
        dica: 'Dica: multiplique a segunda equação para igualar os y e somar.',
        explicacao: 'Da primeira: x = 8 - 2y. Substituindo na segunda: 3(8 - 2y) - y = 5 → 24 - 6y - y = 5 → 7y = 19 → y = 2.5, x = 3.'
      },
      {
        type: 'linear_system',
        pergunta: `2x + y = 7\n4x - 2y = 6`,
        text: `Resolva o sistema:\n2x + y = 7\n4x - 2y = 6`,
        resposta: '2,3',
        dica: 'Dica: multiplique a primeira equação por 2 para eliminar y.',
        explicacao: 'Multiplicando a primeira: 4x + 2y = 14. Somando com a segunda: 4x - 2y = 6 → 8x = 20 → x = 2. Substituindo: 2x + y = 7 → 4 + y = 7 → y = 3.'
      },
      // --- New Challenge Types ---
      {
        type: 'vector_sum',
        text: 'Calcule a soma dos vetores v = [1, 2, 3] e u = [4, 5, 6].\nResponda no formato: [x,y,z]',
        pergunta: 'Calcule a soma dos vetores v = [1, 2, 3] e u = [4, 5, 6].', // Keeping for potential backward compatibility or specific parsing
        resposta: '[5,7,9]',
        dica: 'Some os componentes correspondentes de cada vetor.',
        explicacao: 'A soma de vetores é (v1+u1, v2+u2, v3+u3). Então, (1+4, 2+5, 3+6) = (5, 7, 9).'
      },
      {
        type: 'matrix_sum',
        text: 'Calcule a soma das matrizes A = [[1, 2], [3, 4]] e B = [[5, 6], [7, 8]].\nResponda no formato: [[a,b],[c,d]]',
        pergunta: 'Calcule a soma das matrizes A = [[1, 2], [3, 4]] e B = [[5, 6], [7, 8]].',
        resposta: '[[6,8],[10,12]]',
        dica: 'Some os elementos correspondentes de cada matriz.',
        explicacao: 'A soma de matrizes é [[A11+B11, A12+B12], [A21+B21, A22+B22]]. Então, [[1+5, 2+6], [3+7, 4+8]] = [[6, 8], [10, 12]].'
      },
      {
        type: 'linear_transformation_2d',
        text: 'Aplique a transformação linear T(x, y) = (2x + y, x - y) ao vetor v = [3, 2].\nResponda no formato: [x\',y\']',
        pergunta: 'Aplique a transformação linear T(x, y) = (2x + y, x - y) ao vetor v = [3, 2].',
        resposta: '[8,1]',
        dica: 'Substitua x e y do vetor v na definição da transformação T.',
        explicacao: 'T(3, 2) = (2*3 + 2, 3 - 2) = (6 + 2, 1) = (8, 1).'
      }
    ];

    function verificarTodosPortaisConcluidos() {
      const todosConcluidos = locaisAldeia.every(l => l.concluido);
      if (todosConcluidos) {
        // Ensure customAlert is available or use standard alert as fallback
        if (typeof showCustomAlert === "function") {
            showCustomAlert("Parabéns! Você selou todos os portais e salvou a aldeia!");
        } else {
            alert("Parabéns! Você selou todos os portais e salvou a aldeia!");
        }
        // Further game end logic can be added here, e.g., disabling NPC interaction for new tasks.
        // For now, NPC will also give a similar message if talked to.
      }
      return todosConcluidos;
    }

    function apresentarDesafio(challenge, localNome) { 
      currentChallengeDetails = { challenge, localNome }; // Set global for access by skip logic
      // clearInterval(cronometro); // Removed

      if (!challenge) { // Use the passed challenge object
        console.error("Nenhum desafio fornecido para apresentar.");
        return; 
      }
      // portalAtual is still used for context like marking as 'concluido'
      if (!portalAtual) {
        console.error("Nenhum portalAtual definido ao apresentar desafio.");
        return;
      }

      let promptText = challenge.text;
      if (challenge.type === 'linear_system') {
        promptText += '\nDigite o valor de x e y separados por vírgula (ex: 2,1):';
      }

      showCustomPrompt(promptText, function(resposta) {
        if (resposta && resposta.trim().toLowerCase() === challenge.resposta.toLowerCase()) { 
          desafiosConcluidosContador++;
          const recompensaAtual = desafiosConcluidosContador * 5;
          moedasJogador += recompensaAtual;
          console.log(`Desafio ${desafiosConcluidosContador} concluído. Recompensa: ${recompensaAtual}. Total de moedas: ${moedasJogador}`);
          
          if (portalAtual && portalAtual.id === 'ferraria') {
            desafioFerrariaConcluido = true;
            console.log("Gatilho ativado: Desafio da Ferraria ('ferraria') concluído!");
          }

          showCustomAlert(
            `Correto! Portal em ${localNome} selado!\nVocê ganhou ${recompensaAtual} moedas!\n\n${challenge.explicacao}\n\nVolte a falar comigo para sua próxima tarefa.`, 
            () => {
              atualizarHud(); // Update HUD with new coins (and same lives)
              
              if (portalAtual) { 
                  portalAtual.concluido = true;
                  if (portalAtual.portalElement) {
                      portalAtual.portalElement.classList.remove('active-portal'); 
                      portalAtual.portalElement.style.display = 'none'; 
                  }
              }
              portalAtual = null; 
              verificarTodosPortaisConcluidos();
            }
          );
        } else if (resposta !== null) { 
          vidasJogador--;
          atualizarHud(); // Update HUD with new lives
          atualizarModalDisplays(); // Also update modal if it re-appears or is part of retry

          if (vidasJogador <= 0) {
            // clearInterval(cronometro); // Removed
            showCustomAlert("Fim de Jogo! Suas vidas acabaram. O portal repele você...", () => {
              location.reload(); 
            });
          } else {
            // Player loses a life. The challenge at this portal remains the SAME.
              showCustomAlert(`Resposta incorreta... Você perdeu uma vida. Tente este desafio novamente.\n${challenge.dica}`, () => {
                // Re-present the same challenge by calling showCustomPrompt again with the same challenge text
                // The original prompt is now hidden by the alert.
                // We need to re-show it for the SAME challenge.
                // The callback from showCustomPrompt is what we are in now.
                // So, we call showCustomPrompt again, it will set up its own callback.
                // This means the original callback chain for this attempt ends here.
                // A new one starts for the retry.
                // The `promptText` variable already holds the correct text for the current challenge.
                showCustomPrompt(promptText, arguments.callee); // arguments.callee refers to the current anonymous function (the callback itself)
                                                                // This effectively re-wires the prompt for another attempt at the same challenge.
                                                                // However, this can lead to deep recursion if not careful.
                                                                // A cleaner way is to just re-display the prompt.
                                                                // The current structure of showCustomPrompt is that it's called by apresentarDesafio.
                                                                // Let's ensure the current prompt is re-shown correctly.
                
                // The simplest way to re-try the same challenge is to make sure the prompt modal
                // is re-shown with the same question text, and timer restarts.
                // The `showCustomPrompt` function already does this if called with the same question.
                // The key is that `portalAtual.desafioAtual` (which is our `challenge` object here) has not changed.
                // So, when this alert closes, the game expects the player to interact with the *same* portal.
                // The next collision will call `apresentarDesafio` again with the *same* challenge.
                // Or, if we want to immediately re-open the prompt:
                promptModalQuestion.textContent = promptText; // Ensure question is still there
                promptModalInput.value = ''; // Clear input
                atualizarExibicaoVidas(); // Re-affirm lives display
                customPromptModal.style.display = 'flex'; // Re-show prompt
              promptModalInput.focus();
                // tempo = 60; // Removed
                // atualizarTempo(); // Removed
                // iniciarContador(); // Removed
            });
          }
        } else { // Prompt was cancelled
            // If prompt is cancelled, player doesn't lose a life. 
            // The portal and its challenge remain active. No timer to restart.
        }
      });
    }

    // --- GAME INITIALIZATION & EVENT LISTENERS ---

    function prepararNovaAreaEIniciarRevelacao() {
      console.log("Preparando nova área e iniciando revelação...");
      const reinoPortalAreaEl = document.getElementById('reino-portal-area');

      if (gameArea) gameArea.style.display = 'none';

      if (reinoPortalAreaEl) {
        reinoPortalAreaEl.style.backgroundImage = "url('assets/portalPerigoso.png')"; 
        reinoPortalAreaEl.innerHTML = `
          <div id="mensagem-reino-portal" style="background:rgba(0,0,0,0.75); padding: 50px; border-radius:20px; border: 2px solid #999; max-width: 700px; box-shadow: 0 0 30px rgba(255,255,255,0.2);">
            <h1 style="font-size: 2.6em; margin-bottom: 25px; text-shadow: 1px 1px 3px #000;">Você foi arrastado para um reino desconhecido...</h1>
            <p style="font-size: 1.3em; line-height: 1.6; margin-bottom: 35px; text-shadow: 1px 1px 2px #000;">Nesse novo reino há novos desafios mais difíceis! Você precisa resolver os desafios para atacar os monstros.</p>
            <button id="btn-continuar-reino" style="padding: 15px 35px; font-size: 22px; background: linear-gradient(45deg, #8b6b31, #cca047); border: 2px solid #f0e68c; color: #fff; border-radius: 10px; cursor: pointer; font-family: 'Cinzel', serif; text-shadow: 1px 1px 2px #000;">Continuar...</button>
          </div>
        `;
        reinoPortalAreaEl.style.display = 'flex';
        
        // Position player character BEFORE adding button listener, but it will be under the message overlay.
        x = window.innerWidth / 2 - (personagem.offsetWidth / 2); 
        y = window.innerHeight / 2 - (personagem.offsetHeight / 2); 
        personagem.style.left = x + 'px';
        personagem.style.top = y + 'px';
        personagem.style.display = 'block'; 

        mapaAtual = 'reinoDoPortal';
        console.log("Transicionado para: " + mapaAtual);

        const btnContinuarReino = document.getElementById('btn-continuar-reino');
        if (btnContinuarReino) {
          btnContinuarReino.addEventListener('click', function() {
            const msgReinoPortalEl = document.getElementById('mensagem-reino-portal');
            if (msgReinoPortalEl) {
              msgReinoPortalEl.style.display = 'none'; 
            }
            // Character should now be interactive on the new map background
          });
        } else {
          console.error("Botão #btn-continuar-reino não encontrado após ser adicionado ao DOM.");
        }

      } else {
        console.error("Elemento #reino-portal-area não encontrado!");
      }

      if (transicaoFase) { 
        transicaoFase.style.transition = 'clip-path 1s ease-in-out'; 
        transicaoFase.style.clipPath = 'circle(0% at center)'; 
      } else {
        console.error("Elemento #transicao-fase não encontrado para revelação!");
      }
    }

    function iniciarAnimacaoTransicaoReino() {
      console.log("Iniciando animação de transição para o reino do portal...");
      
      if (transicaoFase) { // Use global transicaoFase
        transicaoFase.style.transition = 'clip-path 1s ease-in-out'; 
        transicaoFase.style.clipPath = 'circle(150% at center)'; 

        setTimeout(prepararNovaAreaEIniciarRevelacao, 1100); 
      } else {
        console.error("Elemento #transicao-fase não encontrado para iniciar animação!");
        prepararNovaAreaEIniciarRevelacao(); 
      }
    }

    modalCloseButton.addEventListener('click', closeCustomAlert);
    promptModalSubmitButton.addEventListener('click', submitCustomPrompt);
    promptModalCancelButton.addEventListener('click', cancelCustomPrompt);
    promptModalInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        submitCustomPrompt();
      }
    });

    document.addEventListener("keydown", function(event) {
      // Modal takes precedence for key events
      if (customPromptModal.style.display === 'flex' && event.key.toLowerCase() === 'p') {
        event.preventDefault(); // Prevent 'p' from being typed into input if focused

        console.log(`Challenge SKIPPED by user: ${currentChallengeDetails.challenge.text} at ${currentChallengeDetails.localNome}`);

        customPromptModal.style.display = 'none';
        
        // pontos++; // Removed erroneous reference
        // pontosEl.textContent = pontos; // Removed erroneous reference

        desafiosConcluidosContador++;
        const recompensaAtualSkip = desafiosConcluidosContador * 5; 
        moedasJogador += recompensaAtualSkip;
        console.log(`Desafio (SKIPPED) ${desafiosConcluidosContador} concluído. Recompensa: ${recompensaAtualSkip}. Total de moedas: ${moedasJogador}`);
        // TODO: Update coin UI display here later -> Done by atualizarHud call

        if (portalAtual) { 
          portalAtual.concluido = true;
          if (portalAtual.id === 'ferraria') { // Check if the skipped portal is 'ferraria'
            desafioFerrariaConcluido = true;
            console.log("Gatilho Ferraria ATIVADO ao PULAR o desafio ('P' key)!");
          }
          if (portalAtual.portalElement) {
            portalAtual.portalElement.style.display = 'none';
            portalAtual.portalElement.classList.remove('active-portal');
          }
        } else {
          console.warn("Tried to skip challenge, but portalAtual was not set when 'P' was pressed.");
          atualizarHud(); // Update HUD even if something went wrong
          showCustomAlert("Desafio pulado! (portalAtual não definido) Volte ao Sábio.", () => { portalAtual = null; });
          return; 
        }
        
        atualizarHud(); // Update HUD with new coins

        showCustomAlert(
          `Desafio em ${currentChallengeDetails.localNome} PULADO!\nVocê ganhou ${recompensaAtualSkip} moedas!\n\n${currentChallengeDetails.challenge.explicacao}\n\nVolte a falar comigo para sua próxima tarefa.`,
          () => {
            portalAtual = null; 
            verificarTodosPortaisConcluidos();
          }
        );
        return; // Important: stop further keydown processing after skipping
      }
      
      if (customModal.style.display === 'flex' || customPromptModal.style.display === 'flex') {
        if (event.key === 'Enter' && customPromptModal.style.display === 'flex' && document.activeElement === promptModalInput) {
          // Already handled by promptModalInput listener
        } else if (event.key === 'Escape') {
          if (customModal.style.display === 'flex') closeCustomAlert();
          if (customPromptModal.style.display === 'flex') cancelCustomPrompt(); // cancelCustomPrompt will also call the promptCallback with null
        }
        return; // Stop further processing if modal is open (and not 'P' for skip)
      }

      // NPC Interaction
      if (event.key.toLowerCase() === 'f') {
        if (mapaAtual === 'aldeia') {
          console.log("--- NPC Interaction Start (Aldeia Map) ---");
          console.log("Estado de locaisAldeia:", JSON.stringify(locaisAldeia, null, 2));
        console.log("desafioFerrariaConcluido:", desafioFerrariaConcluido);
        console.log("jogadorTemPocao:", jogadorTemPocao);
        console.log("esperandoAnuncioPortal:", esperandoAnuncioPortal);
        console.log("portalAtual:", portalAtual ? { id: portalAtual.id, concluido: portalAtual.concluido } : null);
        console.log("--- End NPC Interaction Start Logs ---");

        if (falaNpcPersistenteVisivel === true && !esperandoAnuncioPortal) { 
          falaNpc.style.display = 'none'; 
          if (falaNpcIntervaloDigitacao) { 
            clearInterval(falaNpcIntervaloDigitacao);
            falaNpcIntervaloDigitacao = null;
          }
          falaNpcPersistenteVisivel = false; 
          
          event.preventDefault(); 
          return; 
        }

        if (!falouComNpc) { 
          falouComNpc = true;
          npcHint.style.display = 'none'; 
        }

        if (desafioFerrariaConcluido === true && jogadorTemPocao === false) {
          mostrarFalaDigitada("Você foi valente na Ferraria! Tome esta Poção de Sabedoria. Ela lhe concederá 3 vislumbres da verdade quando mais precisar! (Pressione 'F' para continuar)", true);
          
          jogadorTemPocao = true;
          dicasRestantesPocao = 3;
          atualizarHud(); 
          console.log("Poção de 3 dicas recebida! Esperando 'F' para anúncio do portal.");

          esperandoAnuncioPortal = true; 
          return; 
        
        } else if (esperandoAnuncioPortal === true) {
          if (typeof window.tremerTela !== 'function') {
            window.tremerTela = function() {
              const gameAreaEl = document.getElementById('game-area'); // Use global gameArea
              if (gameAreaEl) { 
                gameAreaEl.classList.add('tela-tremendo');
                console.log("Tela tremendo!");
                setTimeout(() => {
                  gameAreaEl.classList.remove('tela-tremendo');
                }, 500); 
              }
            }
          }
          window.tremerTela(); 

          mostrarFalaDigitada("Mas cuidado! Sinto uma energia terrível emanando de um novo portal... Ele surgiu em X:1200, Y:170! É instável e perigoso, marcado em vermelho!", true); 
          ativarPortalPerigoso(); 
          
          esperandoAnuncioPortal = false; 
          desafioFerrariaConcluido = false; 
          return;

        } else if (portalAtual && portalAtual.id === 'portal_perigoso' && !portalAtual.concluido) {
          mostrarFalaDigitada("O Portal Instável em X:1200, Y:170 ainda é uma ameaça! Você deve investigá-lo, Guardião! É muito perigoso.", true); 
                                          
        } else if (portalAtual === null || (portalAtual && portalAtual.concluido === true)) { 
            let localParaAtivar = null;
            
            for (let i = 0; i < locaisAldeia.length; i++) {
                let indice = (proximoLocalIndex + i) % locaisAldeia.length;
                if (locaisAldeia[indice].id !== 'portal_perigoso' && !locaisAldeia[indice].concluido) {
                    localParaAtivar = locaisAldeia[indice];
                    proximoLocalIndex = (indice + 1) % locaisAldeia.length;
                    break; 
                }
            }
            
            if (localParaAtivar) { 
                 activatePortal(localParaAtivar);
                 mostrarFalaDigitada(`Sinto uma perturbação perto de ${localParaAtivar.nome}. Vá até lá e feche o portal!`);
            } else { 
                const pPerigoso = locaisAldeia.find(l => l.id === 'portal_perigoso');
                if (pPerigoso && !pPerigoso.concluido) { 
                     mostrarFalaDigitada("O portal instável é a única ameaça restante. Devemos lidar com ele!", true); // Persistent
                     if (!portalAtual || portalAtual.id !== 'portal_perigoso') {
                        ativarPortalPerigoso(); 
                     }
                } else { 
                    mostrarFalaDigitada("Você selou todos os portais conhecidos, Guardião! A aldeia está segura... por enquanto.");
                }
            }

        } else if (portalAtual && !portalAtual.concluido) { 
          if (jogadorTemPocao && dicasRestantesPocao > 0 && portalAtual.id !== 'portal_perigoso') { 
             mostrarFalaDigitada(`O portal perto de ${portalAtual.nome} ainda está ativo. Concentre-se! Lembre-se da poção, se precisar de um vislumbre ('H').`);
          } else if (portalAtual && portalAtual.id === 'portal_perigoso') { // Should be caught by the earlier specific else if
             mostrarFalaDigitada(`Este portal é instável! Cuidado, Guardião! Use 'H' para um vislumbre da poção se precisar.`, true); // Persistent
          } else { // Normal active portal, no potion or potion already used for this generic hint
            mostrarFalaDigitada(`O portal perto de ${portalAtual.nome} ainda está ativo. Concentre-se nesse desafio!`);
          }
        }
        // End of Aldeia-specific NPC logic
        } else {
          console.log("Tecla 'F' pressionada no mapa: " + mapaAtual + " - Nenhuma ação de NPC da aldeia.");
        }
      }

      // Character Movement - Boundaries can be improved
      const rect = gameArea.getBoundingClientRect();
      const charRect = personagem.getBoundingClientRect();

      if (event.key === "ArrowUp" && y > 0) y -= passo;
      else if (event.key === "ArrowDown" && y < (rect.height - charRect.height)) y += passo;
      else if (event.key === "ArrowLeft" && x > 0) x -= passo;
      else if (event.key === "ArrowRight" && x < (rect.width - charRect.width)) x += passo;
      
      personagem.style.left = x + "px";
      personagem.style.top = y + "px";

      // Collision with Portal
      if (mapaAtual === 'aldeia' && portalAtual && portalAtual.portalElement && portalAtual.portalElement.style.display === 'block' && !portalAtual.concluido) {
        if (detectarColisao(personagem, portalAtual.portalElement)) {
          if (portalAtual.id === 'portal_perigoso') {
            // Special interaction for the dangerous portal
            showCustomAlert("Você não chegou a tempo! O portal instável o suga para dentro!", iniciarAnimacaoTransicaoReino); 
          } else {
            // Normal portal interaction:
            if (!portalAtual.desafioAtual) { 
              console.warn("Desafio não atribuído ao portal ativo. Atribuindo um aleatório como fallback.");
              portalAtual.desafioAtual = desafios[Math.floor(Math.random() * desafios.length)];
            }
            apresentarDesafio(portalAtual.desafioAtual, portalAtual.nome);
          }
        }
      }
      // else if (mapaAtual === 'reinoDoPortal') {
      //   // Future: Collision logic for monsters in reinoDoPortal
      // }
    });

    // Start the game (typically after all definitions)
    // The menu button `iniciarJogo()` is the primary entry point now.

    // --- UNIT TESTS (for console execution) ---
    function areArraysEqual(arr1, arr2) {
      if (!Array.isArray(arr1) || !Array.isArray(arr2) || arr1.length !== arr2.length) {
        // Check if comparing a non-array value with an array, or if lengths differ
        if (Array.isArray(arr1) !== Array.isArray(arr2)) return false; // One is array, other is not
        return arr1 === arr2; // Handles non-array comparison like numbers or strings directly if both are non-arrays
      }
      for (let i = 0; i < arr1.length; i++) {
        if (Array.isArray(arr1[i]) && Array.isArray(arr2[i])) {
          if (!areArraysEqual(arr1[i], arr2[i])) return false;
        } else if (arr1[i] !== arr2[i]) {
          // Also check type if one is array and other is not at this level
          if (Array.isArray(arr1[i]) !== Array.isArray(arr2[i])) return false;
          return false;
        }
      }
      return true;
    }

    function testVectorSum() {
      console.log("--- Running Vector Sum Tests ---");
      let v1 = [1, 2, 3]; let u1 = [4, 5, 6]; let expected1 = [5, 7, 9];
      let actual1 = v1.map((val, index) => val + u1[index]);
      console.assert(areArraysEqual(actual1, expected1), "Test Vector Sum 1 FAILED: Expected " + JSON.stringify(expected1) + ", Got " + JSON.stringify(actual1));

      let v2 = [-1, 0, 5]; let u2 = [2, -3, -5]; let expected2 = [1, -3, 0];
      let actual2 = v2.map((val, index) => val + u2[index]);
      console.assert(areArraysEqual(actual2, expected2), "Test Vector Sum 2 FAILED: Expected " + JSON.stringify(expected2) + ", Got " + JSON.stringify(actual2));
      
      console.log("--- Vector Sum Tests Complete ---");
    }

    function testMatrixSum() {
      console.log("--- Running Matrix Sum Tests ---");
      let m1 = [[1, 2], [3, 4]]; let n1 = [[5, 6], [7, 8]]; let expectedM1 = [[6, 8], [10, 12]];
      let actualM1 = m1.map((row, i) => row.map((val, j) => val + n1[i][j]));
      console.assert(areArraysEqual(actualM1, expectedM1), "Test Matrix Sum 1 FAILED: Expected " + JSON.stringify(expectedM1) + ", Got " + JSON.stringify(actualM1));

      let m2 = [[1, 0], [0, 1]]; let n2 = [[0, 1], [1, 0]]; let expectedM2 = [[1, 1], [1, 1]];
      let actualM2 = m2.map((row, i) => row.map((val, j) => val + n2[i][j]));
      console.assert(areArraysEqual(actualM2, expectedM2), "Test Matrix Sum 2 FAILED: Expected " + JSON.stringify(expectedM2) + ", Got " + JSON.stringify(actualM2));
      
      console.log("--- Matrix Sum Tests Complete ---");
    }

    function testLinearTransformation() {
      console.log("--- Running Linear Transformation Tests ---");
      let T1 = (x, y) => [2*x + y, x - y];
      let vec1 = [3, 2]; let expectedLT1 = [8, 1];
      let actualLT1 = T1(vec1[0], vec1[1]);
      console.assert(areArraysEqual(actualLT1, expectedLT1), "Test Linear Transformation 1 FAILED: Expected " + JSON.stringify(expectedLT1) + ", Got " + JSON.stringify(actualLT1));

      let T2 = (x, y) => [x, y]; // Identity transformation
      let vec2 = [5, -2]; let expectedLT2 = [5, -2];
      let actualLT2 = T2(vec2[0], vec2[1]);
      console.assert(areArraysEqual(actualLT2, expectedLT2), "Test Linear Transformation 2 FAILED: Expected " + JSON.stringify(expectedLT2) + ", Got " + JSON.stringify(actualLT2));
      
      console.log("--- Linear Transformation Tests Complete ---");
    }

    function runAllChallengeLogicTests() {
      console.log("=== Starting All Challenge Logic Tests ===");
      testVectorSum();
      testMatrixSum();
      testLinearTransformation();
      console.log("=== All Challenge Logic Tests Finished ===");
      console.log("Check console for any FAILED assertions. If all tests passed, no FAILED messages will appear.");
    }
  </script>
